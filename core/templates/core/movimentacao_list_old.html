{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Movimentações{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-exchange-alt me-2"></i>Movimentações de Estoque</h2>
    <a href="{% url 'movimentacao_create' %}" class="btn btn-primary">
        <i class="fas fa-plus me-2"></i>Nova Movimentação
    </a>
</div>

<!-- Formulário de Filtros -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros</h5>
    </div>
    <div class="card-body">
        <form method="get">
            <div class="row g-3">
                <div class="col-md-3">
                    {{ filtro_form.data_inicio.label_tag }}
                    {{ filtro_form.data_inicio }}
                </div>
                <div class="col-md-3">
                    {{ filtro_form.data_fim.label_tag }}
                    {{ filtro_form.data_fim }}
                </div>
                <div class="col-md-3">
                    {{ filtro_form.produto.label_tag }}
                    {{ filtro_form.produto }}
                </div>
                <div class="col-md-3">
                    {{ filtro_form.tipo.label_tag }}
                    {{ filtro_form.tipo }}
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search me-2"></i>Filtrar
                    </button>
                    <a href="{% url 'movimentacao_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-2"></i>Limpar
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Resumo de Totais (quando há filtros aplicados) -->
{% if tem_filtros %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Resumo do Período</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for tipo_codigo, dados in totais.items %}
                        {% if dados.quantidade > 0 %}
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 border-{% if tipo_codigo == 'entrada' %}success{% elif tipo_codigo == 'saida' %}danger{% else %}warning{% endif %}">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-{% if tipo_codigo == 'entrada' %}success{% elif tipo_codigo == 'saida' %}danger{% else %}warning{% endif %}">
                                        {% if tipo_codigo == 'entrada' %}
                                            <i class="fas fa-arrow-up me-2"></i>
                                        {% elif tipo_codigo == 'saida' %}
                                            <i class="fas fa-arrow-down me-2"></i>
                                        {% else %}
                                            <i class="fas fa-edit me-2"></i>
                                        {% endif %}
                                        {{ dados.nome }}
                                    </h6>
                                    <p class="card-text">
                                        <strong>Quantidade:</strong> {{ dados.quantidade }}<br>
                                        <strong>Valor Total:</strong> R$ {{ dados.valor|floatformat:2 }}
                                    </p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-chart-line me-2"></i>Total Geral:</h6>
                            <strong>Quantidade Total:</strong> {{ quantidade_total_geral }} unidades<br>
                            <strong>Valor Total:</strong> R$ {{ valor_total_geral|floatformat:2 }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Tabela de Movimentações -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th><i class="fas fa-calendar me-1"></i>Data/Hora</th>
                        <th><i class="fas fa-box me-1"></i>Produto</th>
                        <th><i class="fas fa-exchange-alt me-1"></i>Tipo</th>
                        <th><i class="fas fa-cubes me-1"></i>Quantidade</th>
                        <th><i class="fas fa-dollar-sign me-1"></i>Valor Unit.</th>
                        <th><i class="fas fa-calculator me-1"></i>Valor Total</th>
                        <th class="d-none d-md-table-cell"><i class="fas fa-user me-1"></i>Usuário</th>
                        <th class="d-none d-md-table-cell"><i class="fas fa-comment me-1"></i>Observação</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mov in page_obj %}
                    <tr>
                        <td>{{ mov.data_movimentacao|date:'d/m/Y H:i' }}</td>
                        <td>
                            <strong>{{ mov.produto.nome }}</strong><br>
                            <small class="text-muted">{{ mov.produto.codigo }}</small>
                        </td>
                        <td>
                            <span class="badge bg-{% if mov.tipo == 'entrada' %}success{% elif mov.tipo == 'saida' %}danger{% else %}warning{% endif %}">
                                {% if mov.tipo == 'entrada' %}
                                    <i class="fas fa-arrow-up me-1"></i>
                                {% elif mov.tipo == 'saida' %}
                                    <i class="fas fa-arrow-down me-1"></i>
                                {% else %}
                                    <i class="fas fa-edit me-1"></i>
                                {% endif %}
                                {{ mov.get_tipo_display }}
                            </span>
                        </td>
                        <td>
                            <strong>
                                {% if mov.tipo == 'entrada' %}+{% elif mov.tipo == 'saida' %}-{% endif %}{{ mov.quantidade }}
                            </strong>
                        </td>
                        <td>
                            {% if mov.preco_unitario %}
                                R$ {{ mov.preco_unitario|floatformat:2 }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if mov.preco_unitario %}
                                <strong>R$ {{ mov.valor_total|floatformat:2 }}</strong>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="d-none d-md-table-cell">{{ mov.usuario.first_name|default:mov.usuario.username }}</td>
                        <td class="d-none d-md-table-cell">
                            {% if mov.observacao %}
                                {{ mov.observacao|truncatechars:30 }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <br>Nenhuma movimentação encontrada.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Paginação -->
        {% if page_obj.has_other_pages %}
        <nav aria-label="Navegação das movimentações" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.previous_page_number }}">
                            <i class="fas fa-chevron-left"></i> Anterior
                        </a>
                    </li>
                {% endif %}
                
                <li class="page-item active">
                    <span class="page-link">
                        Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                    </span>
                </li>
                
                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if request.GET.urlencode %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.next_page_number }}">
                            Próxima <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

{% block extra_css %}
<style>
    .badge {
        font-size: 0.85em;
    }
    .table td {
        vertical-align: middle;
    }
    .alert-info {
        border-left: 4px solid #0dcaf0;
    }
</style>
{% endblock %}
